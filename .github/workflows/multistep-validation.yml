---
name: Multi-Step Validation

# This workflow validates multi-step AWS API call scenarios by checking which
# operations require parameters that can be resolved from list operations.
# Runs weekly and on main branch pushes to track API compatibility over time.

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:  # Manual trigger

jobs:
  validate:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block other CI jobs if validation fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run multi-step validation
        run: |
          python scripts/validate_multistep_functions.py

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()  # Upload report even if validation finds issues
        with:
          name: multistep-validation-report
          path: multistep-validation-report.json
          retention-days: 90

      - name: Check for critical issues
        if: always()
        run: |
          # Parse report and check if broken count is high
          if [ -f multistep-validation-report.json ]; then
            broken_count=$(jq '.statistics.multi_step_scenarios.broken' multistep-validation-report.json)
            echo "Found $broken_count broken multi-step scenarios"

            # Log warning if count is high, but don't fail
            if [ "$broken_count" -gt 10 ]; then
              echo "::warning::Found $broken_count broken multi-step scenarios - review may be needed"
            fi
          fi
